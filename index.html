<!-- GANTI LINK TEMPLATE TWIBBON DI BAWAH INI -->
<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twibbon Generator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    #preview-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      aspect-ratio: 1;
      margin: 0 auto;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #e5e7eb;
    }
    
    #user-photo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center center;
      max-width: none;
    }
    
    #twibbon-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      z-index: 10;
    }
    
    .hidden {
      display: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full" style="background: linear-gradient(135deg, #ffbf00 0%, #002899 100%);">
  <div class="w-full h-full overflow-auto">
   <div class="min-h-full w-full" id="main-wrapper">
    <div class="max-w-4xl mx-auto px-6 py-12"><!-- Header -->
     <div class="text-center mb-8">
     <div class="mb-8">
      <div id="preview-container"><img id="user-photo" class="hidden" alt="Foto Anda"> <!-- 
              GANTI LINK TEMPLATE TWIBBON DI BAWAH INI
              Cara: Copy path file PNG template Anda, lalu paste di src=""
              Contoh: src="./template-twibbon.png" atau src="https://example.com/twibbon.png"
            --> <img id="twibbon-frame" src="./Twibbonppdb.png" alt="Frame Twibbon" onerror="this.src=''; this.alt='Template gagal dimuat. Pastikan file ada di folder yang sama dengan HTML ini.';">
       <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-center p-8 bg-gray-100">
        <div><i class="fas fa-image text-6xl text-gray-400 mb-4"></i>
         <p class="text-lg font-semibold text-gray-700">Upload Foto Anda</p>
         <p class="text-sm text-gray-500 mt-2">Klik tombol di bawah untuk memilih foto</p>
        </div>
       </div>
      </div>
     </div><!-- Controls -->
     <div class="flex flex-col gap-4 justify-center items-center mb-10">
      <div class="flex flex-col sm:flex-row gap-4"><input type="file" id="photo-input" accept="image/*" class="hidden"> <button id="upload-btn" class="px-6 py-3 rounded-lg font-semibold text-base shadow-md text-white bg-blue-600 hover:bg-blue-700 transition-colors"> <i class="fas fa-upload mr-2"></i><span id="upload-btn-text">Pilih Foto</span> </button> <button id="download-btn" class="hidden px-6 py-3 rounded-lg font-semibold text-base shadow-md text-white bg-green-600 hover:bg-green-700 transition-colors"> <i class="fas fa-download mr-2"></i><span id="download-btn-text">Download Twibbon</span> </button>
      </div><!-- Photo Adjustment Controls -->
      <div id="adjustment-controls" class="hidden w-full max-w-md bg-white rounded-lg shadow-sm p-6 mt-4">
       <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-sliders-h mr-2"></i>Atur Posisi Foto</h3><!-- Zoom Control -->
       <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-search-plus mr-1"></i>Zoom </label> <input type="range" id="zoom-slider" min="50" max="200" value="100" class="w-full">
        <div class="text-center text-sm text-gray-600 mt-1">
         <span id="zoom-value">100</span>%
        </div>
       </div><!-- Position Controls -->
       <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-arrows-alt mr-1"></i>Posisi </label>
        <div class="grid grid-cols-2 gap-3">
         <div><label class="block text-xs text-gray-600 mb-1">Horizontal</label> <input type="range" id="position-x" min="-100" max="100" value="0" class="w-full">
         </div>
         <div><label class="block text-xs text-gray-600 mb-1">Vertikal</label> <input type="range" id="position-y" min="-100" max="100" value="0" class="w-full">
         </div>
        </div>
       </div><!-- Reset Button --> <button id="reset-btn" class="w-full px-4 py-2 rounded-lg font-medium text-sm text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors"> <i class="fas fa-undo mr-2"></i>Reset Posisi </button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      background_gradient_start: '#1c432c',
      background_gradient_end: '#f5d746',
      text_color: '#ffffff',
      button_color: '#1c432c',
      font_family: 'system-ui, -apple-system, sans-serif',
      font_size: 16,
      main_title: '',
      subtitle: '',
      instruction_text: 'Upload foto Anda dan download twibbon untuk dibagikan di media sosial!',
      upload_button_text: 'Pilih Foto',
      download_button_text: 'Download Twibbon'
    };

    async function onConfigChange(config) {
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgGradientStart = config.background_gradient_start || defaultConfig.background_gradient_start;
      const bgGradientEnd = config.background_gradient_end || defaultConfig.background_gradient_end;
      const textColor = config.text_color || defaultConfig.text_color;
      const btnColor = config.button_color || defaultConfig.button_color;
      
      document.body.style.background = `linear-gradient(135deg, ${bgGradientStart} 0%, ${bgGradientEnd} 100%)`;
      
      const mainWrapper = document.getElementById('main-wrapper');
      mainWrapper.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      const mainTitle = document.getElementById('main-title');
      mainTitle.textContent = config.main_title || defaultConfig.main_title;
      mainTitle.style.fontSize = `${baseSize * 2.5}px`;
      mainTitle.style.color = textColor;
      mainTitle.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      const subtitle = document.getElementById('subtitle');
      subtitle.textContent = config.subtitle || defaultConfig.subtitle;
      subtitle.style.fontSize = `${baseSize * 1.25}px`;
      subtitle.style.color = textColor;
      subtitle.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      const instruction = document.getElementById('instruction');
      instruction.textContent = config.instruction_text || defaultConfig.instruction_text;
      instruction.style.fontSize = `${baseSize}px`;
      instruction.style.color = textColor;
      instruction.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.style.backgroundColor = btnColor;
      
      const uploadBtnText = document.getElementById('upload-btn-text');
      uploadBtnText.textContent = config.upload_button_text || defaultConfig.upload_button_text;
      
      const downloadBtn = document.getElementById('download-btn');
      downloadBtn.style.backgroundColor = btnColor;
      
      const downloadBtnText = document.getElementById('download-btn-text');
      downloadBtnText.textContent = config.download_button_text || defaultConfig.download_button_text;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_gradient_start || defaultConfig.background_gradient_start,
              set: (value) => {
                window.elementSdk.config.background_gradient_start = value;
                window.elementSdk.setConfig({ background_gradient_start: value });
              }
            },
            {
              get: () => config.background_gradient_end || defaultConfig.background_gradient_end,
              set: (value) => {
                window.elementSdk.config.background_gradient_end = value;
                window.elementSdk.setConfig({ background_gradient_end: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                window.elementSdk.config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.button_color || defaultConfig.button_color,
              set: (value) => {
                window.elementSdk.config.button_color = value;
                window.elementSdk.setConfig({ button_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              window.elementSdk.config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              window.elementSdk.config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ['main_title', config.main_title || defaultConfig.main_title],
          ['subtitle', config.subtitle || defaultConfig.subtitle],
          ['instruction_text', config.instruction_text || defaultConfig.instruction_text],
          ['upload_button_text', config.upload_button_text || defaultConfig.upload_button_text],
          ['download_button_text', config.download_button_text || defaultConfig.download_button_text]
        ])
      });
    }

    const photoInput = document.getElementById('photo-input');
    const uploadBtn = document.getElementById('upload-btn');
    const downloadBtn = document.getElementById('download-btn');
    const userPhoto = document.getElementById('user-photo');
    const placeholder = document.getElementById('placeholder');
    const adjustmentControls = document.getElementById('adjustment-controls');
    const zoomSlider = document.getElementById('zoom-slider');
    const zoomValue = document.getElementById('zoom-value');
    const positionX = document.getElementById('position-x');
    const positionY = document.getElementById('position-y');
    const resetBtn = document.getElementById('reset-btn');

    let photoTransform = {
      scale: 1,
      x: 0,
      y: 0
    };

    let photoAspectRatio = 1;
    let containerSize = 0;

    function updatePhotoTransform() {
      const scalePercent = zoomSlider.value;
      const scale = scalePercent / 100;
      const x = positionX.value;
      const y = positionY.value;
      
      photoTransform.scale = scale;
      photoTransform.x = x;
      photoTransform.y = y;
      
      // Hitung ukuran foto berdasarkan aspect ratio
      let photoWidth, photoHeight;
      if (photoAspectRatio > 1) {
        // Landscape
        photoWidth = containerSize;
        photoHeight = containerSize / photoAspectRatio;
      } else {
        // Portrait atau square
        photoHeight = containerSize;
        photoWidth = containerSize * photoAspectRatio;
      }
      
      userPhoto.style.width = photoWidth + 'px';
      userPhoto.style.height = photoHeight + 'px';
      userPhoto.style.transform = `translate(-50%, -50%) translate(${x}%, ${y}%) scale(${scale})`;
      zoomValue.textContent = scalePercent;
    }

    uploadBtn.addEventListener('click', () => {
      photoInput.click();
    });

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          userPhoto.src = event.target.result;
          
          userPhoto.onload = () => {
            // Hitung aspect ratio foto
            photoAspectRatio = userPhoto.naturalWidth / userPhoto.naturalHeight;
            
            // Dapatkan ukuran container
            const container = document.getElementById('preview-container');
            containerSize = container.offsetWidth;
            
            userPhoto.classList.remove('hidden');
            placeholder.classList.add('hidden');
            downloadBtn.classList.remove('hidden');
            adjustmentControls.classList.remove('hidden');
            
            // Reset transform
            zoomSlider.value = 100;
            positionX.value = 0;
            positionY.value = 0;
            updatePhotoTransform();
          };
        };
        reader.readAsDataURL(file);
      }
    });

    zoomSlider.addEventListener('input', updatePhotoTransform);
    positionX.addEventListener('input', updatePhotoTransform);
    positionY.addEventListener('input', updatePhotoTransform);

    resetBtn.addEventListener('click', () => {
      zoomSlider.value = 100;
      positionX.value = 0;
      positionY.value = 0;
      updatePhotoTransform();
    });

    downloadBtn.addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Load foto user
      const photoImg = new Image();
      photoImg.src = userPhoto.src;
      
      await new Promise((resolve) => {
        photoImg.onload = resolve;
      });
      
      // Load frame twibbon
      const frameImg = new Image();
      frameImg.src = document.getElementById('twibbon-frame').src;
      
      await new Promise((resolve) => {
        frameImg.onload = resolve;
      });
      
      // Gunakan ukuran yang lebih besar untuk kualitas terbaik
      const targetSize = Math.max(photoImg.width, photoImg.height, frameImg.width, frameImg.height, 1080);
      
      canvas.width = targetSize;
      canvas.height = targetSize;
      
      // Simpan context state
      ctx.save();
      
      // Pindahkan origin ke tengah canvas
      ctx.translate(targetSize / 2, targetSize / 2);
      
      // Aplikasikan transform
      ctx.translate(
        (photoTransform.x / 100) * targetSize,
        (photoTransform.y / 100) * targetSize
      );
      ctx.scale(photoTransform.scale, photoTransform.scale);
      
      // Gambar foto dengan mempertahankan aspect ratio asli
      let drawWidth, drawHeight;
      const photoAspect = photoImg.width / photoImg.height;
      
      if (photoAspect > 1) {
        // Landscape
        drawWidth = targetSize;
        drawHeight = targetSize / photoAspect;
      } else {
        // Portrait atau square
        drawHeight = targetSize;
        drawWidth = targetSize * photoAspect;
      }
      
      ctx.drawImage(photoImg, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
      
      // Restore context state
      ctx.restore();
      
      // Gambar frame twibbon di atas foto
      ctx.drawImage(frameImg, 0, 0, targetSize, targetSize);
      
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'twibbon-psb-mabash.png';
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/png');
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad0d0506034a131',t:'MTc2NTU4MDE3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
